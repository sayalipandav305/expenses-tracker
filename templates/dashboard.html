<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>


/* Dashboard Styles */
body {
    font-family: 'Inter', Arial, sans-serif;
    background: #f4f5f7;
    margin: 0; padding: 0;
}
.container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 20px 30px;
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 4px 40px rgba(0,0,0,0.1);
}
h1 { font-size: 1.6rem; margin-bottom: 20px; color: #333; }

.dashboard-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;
}

.stats-cards { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px; }
.stats-card { flex: 1; min-width: 150px; background: #f9fafc; border-radius: 14px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.03); }
.stats-card-title { font-size: 0.9rem; color: #617187; margin-bottom: 5px; }
.stats-card-value { font-size: 1.4rem; color: #282828; font-weight: bold; }

.budget-section { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
.budget-section input { padding: 7px 12px; border-radius: 6px; border: 1px solid #ccc; }
.budget-section button { background: #39a2ff; color: #fff; border: none; padding: 7px 14px; border-radius: 6px; cursor: pointer; }

.main-content { display: flex; gap: 25px; flex-wrap: wrap; }
.left-column { flex: 1; min-width: 320px; }
.right-column { flex: 2; min-width: 550px; }

.card { background: #fff; border-radius: 14px; padding: 20px; margin-bottom: 25px; box-shadow: 0 1px 4px rgba(0,0,0,0.03); }

input, select { width: 100%; padding: 8px 12px; margin-bottom: 12px; border-radius: 6px; border: 1px solid #ddd; }
button { cursor: pointer; }

.expenses-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.expenses-table th, .expenses-table td { padding: 10px; text-align: left; }
.expenses-table th { background: #f5f6fa; color: #555; }
.expenses-table td { border-bottom: 1px solid #e0e0e0; }
.delete-btn { background: none; border: none; color: #ff4c4c; cursor: pointer; }

.chart-container { width: 100%; height: 300px; }

@media (max-width: 900px) { .main-content { flex-direction: column; } }
</style>
</head>
<body>
<div class="container">
    <h1>Dashboard</h1>

    <div class="dashboard-header">
        <span style="font-weight:bold;">Finance Tracker</span>
        <div style="display:flex; align-items:center; gap:15px;">
            <span>Hi, {{ username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
        </div>
    </div>

    <!-- Budget Section -->
    <div class="budget-section">
        <form action="{{ url_for('set_budget') }}" method="POST" style="display:flex; gap:10px; flex-wrap: wrap;">
            <input type="number" step="0.01" name="budget" placeholder="Set Budget" required>
            <button type="submit">Set Budget</button>
        </form>
        <span>Current Budget: {{ currency }}{{ budget|default(0) }}</span>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stats-card">
            <div class="stats-card-title">Total Expenses</div>
            <div class="stats-card-value">{{ currency }}{{ total_expense }}</div>
        </div>
        <div class="stats-card">
            <div class="stats-card-title">Number of Expenses</div>
            <div class="stats-card-value">{{ num_expenses }}</div>
        </div>
        <div class="stats-card">
            <div class="stats-card-title">Highest Category</div>
            <div class="stats-card-value">{{ highest_category }}</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Left Column: Add Expense & Filter -->
        <div class="left-column">
            <div class="card">
                <h3>Add Expense</h3>
                <form action="{{ url_for('add_expense') }}" method="POST" enctype="multipart/form-data">
                    <input type="number" step="0.01" name="amount" placeholder="Amount" required>
                    <select name="category" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Food">Food</option>
                        <option value="Transport">Transport</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Bills">Bills</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Health">Health</option>
                        <option value="Others">Others</option>
                    </select>
                    <input type="text" name="description" placeholder="Description">
                    <input type="date" name="date" required>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="checkbox" name="recurring"> Recurring
                        <select name="frequency">
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <input type="file" name="receipt">
                    <button type="submit" style="background:#39a2ff;color:white;">Add Expense</button>
                </form>
            </div>

            <div class="card">
                <h3>Filter Expenses</h3>
                <form method="GET" action="{{ url_for('dashboard') }}">
                    <input type="text" name="search" placeholder="Search description" value="{{ search or '' }}">
                    <select name="category">
                        <option value="">All Categories</option>
                        <option value="Food" {% if category=="Food" %}selected{% endif %}>Food</option>
                        <option value="Transport" {% if category=="Transport" %}selected{% endif %}>Transport</option>
                        <option value="Shopping" {% if category=="Shopping" %}selected{% endif %}>Shopping</option>
                        <option value="Bills" {% if category=="Bills" %}selected{% endif %}>Bills</option>
                        <option value="Entertainment" {% if category=="Entertainment" %}selected{% endif %}>Entertainment</option>
                    </select>
                    <input type="date" name="from" value="{{ from_date or '' }}">
                    <input type="date" name="to" value="{{ to_date or '' }}">
                    <button type="submit" style="background:#39a2ff;color:white;">Filter</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Clear</a>
                    <a href="{{ url_for('export_csv') }}" class="btn btn-success">Export CSV</a>
                </form>
            </div>
        </div>

        <!-- Right Column: Table & Chart -->
        <div class="right-column">
            <div class="card">
                <h3>Expenses</h3>
                <div style="overflow-x:auto;">
                    <table class="expenses-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Recurring</th>
                                <th>Receipt</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for exp in expenses %}
                            <tr {% if budget>0 and total_expense>budget %}style="background:#ffe5e5"{% endif %}>
                                <td>{{ exp.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ exp.description }}</td>
                                <td>{{ exp.category }}</td>
                                <td>{{ currency }}{{ exp.amount }}</td>
                                <td>{{ 'Yes' if exp.recurring else 'No' }}</td>
                                <td>
                                    {% if exp.receipt %}
                                        <a href="{{ url_for('static', filename='uploads/' ~ exp.receipt) }}" target="_blank">View</a>
                                    {% else %}N/A{% endif %}
                                </td>
                                <td>
                                    <button class="delete-btn" data-id="{{ exp['_id'] }}">Delete</button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Spending by Category</h3>
                <canvas id="expenseChart" class="chart-container"></canvas>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Chart.js
fetch('{{ url_for("totals") }}')
.then(res => res.json())
.then(data => {
    const labels = data.map(i => i._id);
    const totals = data.map(i => i.total);
    new Chart(document.getElementById('expenseChart').getContext('2d'), {
        type: 'pie',
        data: { labels, datasets:[{data:totals, backgroundColor:['#2573ec','#f6ae35','#2ac99c','#eb5858','#8e44ad','#e67e22']}]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
    });
});

// AJAX Delete
document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const expId=btn.dataset.id;
        if(confirm('Are you sure you want to delete this expense?')){
            fetch(`/delete/${expId}`,{method:'DELETE'})
            .then(res=>res.json())
            .then(data=>{
                if(data.success){ btn.closest('tr').remove(); }
                else{ alert('Failed to delete expense'); }
            });
        }
    });
});


</script>
</body>
</html>
